<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Client Dashboard — Click & Care</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <span class="logo">CC</span>
        <span class="brand-text">Click &amp; Care</span>
      </a>
      <nav class="nav">
        <ul class="nav-list">
          <li><a href="index.html">Home</a></li>
          <li><a href="services.html">Services</a></li>
          <li><a class="active" href="client-dashboard.html">Dashboard</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <section class="section">
    <div class="container" style="max-width:800px">
      <h1>Welcome, <span id="clientName"></span></h1>
      <div class="card">
        <p><strong>Plan:</strong> <span id="clientPlan"></span></p>
        <p><strong>Technician:</strong> <span id="clientTech"></span></p>
        <p><strong>Visits Left:</strong> <span id="visitsLeft"></span></p>
      </div>

      <h2 style="margin-top:40px;">Upcoming Appointments</h2>
      <div id="appointments" class="card">
        <p>Loading appointments...</p>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="footer-bottom">
      © <span id="year"></span> Click & Care. All rights reserved.
    </div>
  </footer>

  <!-- Firebase Connection -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, collection, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADe9mr_6oE5L8lK8enCM2R43IJUz1GVcg",
      authDomain: "click-and-care-client-portal.firebaseapp.com",
      projectId: "click-and-care-client-portal",
      storageBucket: "click-and-care-client-portal.firebasestorage.app",
      messagingSenderId: "469706454671",
      appId: "1:469706454671:web:663408e0c167884126e2fa",
      measurementId: "G-G1NXSLG0VK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Load client data
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // window.location.href = "client-login.html"; 
        // return;
      }

      const docRef = doc(db, "users", "UYe5RSIvU56f2YlciLmx");
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("clientName").textContent = data.name;
        document.getElementById("clientPlan").textContent = data.plan;
        document.getElementById("clientTech").textContent = data.technician;
        document.getElementById("visitsLeft").textContent = data.visitsLeft;

        // Load appointments
        const q = query(collection(db, "Appointments"), where("clientName", "==", data.name));
        const querySnapshot = await getDocs(q);
        const appointmentContainer = document.getElementById("appointments");

        if (querySnapshot.empty) {
          appointmentContainer.innerHTML = "<p>No appointments found.</p>";
        } else {
          appointmentContainer.innerHTML = "";

          // Sort appointments by date (soonest first)
          const appointments = [];
          querySnapshot.forEach((doc) => appointments.push(doc.data()));
          appointments.sort((a, b) => {
            const dateA = a.dateTime?.seconds || 0;
            const dateB = b.dateTime?.seconds || 0;
            return dateA - dateB;
          });

          appointments.forEach((appt) => {
            // Format readable date
            let readableDate = "";
            if (appt.dateTime && appt.dateTime.seconds) {
              const dateObj = new Date(appt.dateTime.seconds * 1000);
              readableDate = dateObj.toLocaleString("en-US", {
                weekday: "short",
                month: "long",
                day: "numeric",
                year: "numeric",
                hour: "numeric",
                minute: "2-digit",
              });
            } else {
              readableDate = appt.dateTime || "N/A";
            }

            // Color badge for status
            let statusColor = "gray";
            if (appt.status?.toLowerCase() === "pending") statusColor = "orange";
            else if (appt.status?.toLowerCase() === "completed") statusColor = "green";
            else if (appt.status?.toLowerCase() === "cancelled") statusColor = "red";

            appointmentContainer.innerHTML += `
              <div class="appointment-item" style="padding:16px;border-bottom:1px solid var(--border);">
                <p><strong>Service:</strong> ${appt.service}</p>
                <p><strong>Date/Time:</strong> ${readableDate}</p>
                <p><strong>Location:</strong> ${appt.location}</p>
                <p><strong>Status:</strong> 
                   <span style="
                     color:white;
                     background:${statusColor};
                     padding:4px 10px;
                     border-radius:12px;
                     font-size:0.9em;">
                     ${appt.status}
                   </span>
                </p>
                <p><strong>Technician:</strong> ${appt.workerEmail}</p>
                <div style="margin-top:10px;">
                  <button style="
                    padding:6px 12px;
                    border:none;
                    border-radius:8px;
                    background:#444;
                    color:white;
                    cursor:not-allowed;
                    opacity:0.5;">
                    Cancel (coming soon)
                  </button>
                </div>
              </div>
            `;
          });
        }
        
      } else {
        console.log("No user data found!");
      }
    });

    document.getElementById("year").textContent = new Date().getFullYear();
  </script>
</body>
</html>
